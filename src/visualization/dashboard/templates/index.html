<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EuroPulse - Real-Time Threat Detection</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="header">
        <h1>üö® EuroPulse - Real-Time Threat Detection</h1>
        <p>Monitoring French & German social media for physical threats</p>
    </div>

    <div class="dashboard">
        <div class="card">
            <h2>üìä Threat Statistics</h2>
            <div class="stats-grid" id="stats-grid">
                <!-- Stats will be populated by JavaScript -->
            </div>
        </div>

        <div class="card">
            <h2>üåç Threat Map</h2>
            <canvas id="threatChart"></canvas>
        </div>

        <div class="card threat-list">
            <h2>üö® CRITICAL ALERTS</h2>
            <div id="critical-alerts">
                <!-- Critical threats will go here -->
            </div>
            
            <h2>‚ö†Ô∏è ACTIVE THREATS</h2>
            <div id="active-threats">
                <!-- Other threats will go here -->
            </div>
            
            <h2>üìã ONGOING MONITORING</h2>
            <div id="ongoing-threats">
                <!-- Low-priority threats will go here -->
            </div>
        </div>
    </div>

    <script>
        let threatChart;

        async function updateDashboard() {
            // Fetch current threats
            const threatsResponse = await fetch('/api/threats');
            const threatsData = await threatsResponse.json();
            
            // Fetch statistics
            const statsResponse = await fetch('/api/stats');
            const statsData = await statsResponse.json();
            
            updateStats(statsData);
            updateThreatsList(threatsData.threats);
            updateChart(statsData);
        }

        function updateStats(stats) {
            const statsGrid = document.getElementById('stats-grid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <h3>Active Threats</h3>
                    <div style="font-size: 2em; color: #ff0000;">${stats.total_threats}</div>
                </div>
                <div class="stat-card">
                    <h3>High/Critical</h3>
                    <div style="font-size: 2em; color: #ff6b00;">${stats.risk_levels.high + stats.risk_levels.critical}</div>
                </div>
                <div class="stat-card">
                    <h3>Countries</h3>
                    <div style="font-size: 2em; color: #00ff00;">${Object.keys(stats.countries).length}</div>
                </div>
            `;
        }

        function updateThreatsList(threats) {
            // Separate threats by priority
            const criticalAlerts = threats.filter(t => 
                t.threat_classification?.risk_level === 'critical' || 
                (t.threat_classification?.risk_level === 'high' && t.threat_classification?.urgency_detected)
            );
            
            const activeThreats = threats.filter(t => 
                t.threat_classification?.risk_level === 'high' && 
                !criticalAlerts.includes(t)
            );
            
            const ongoingThreats = threats.filter(t => 
                t.threat_classification?.risk_level === 'medium' || 
                t.threat_classification?.risk_level === 'low'
            );

            updateThreatSection('critical-alerts', criticalAlerts, 'üö® CRITICAL ALERT - IMMEDIATE RESPONSE NEEDED');
            updateThreatSection('active-threats', activeThreats, 'No high-priority threats');
            updateThreatSection('ongoing-threats', ongoingThreats, 'No ongoing threats');
        }

        function updateThreatSection(sectionId, threats, emptyMessage) {
            const section = document.getElementById(sectionId);
            
            if (threats.length === 0) {
                section.innerHTML = `<div class="threat-item low">${emptyMessage}</div>`;
                return;
            }
            
            section.innerHTML = threats.map(threat => {
                const classification = threat.threat_classification || {};
                const riskLevel = classification.risk_level || 'low';
                const locations = threat.locations || [];
                const isUrgent = classification.urgency_detected;
                const isCritical = riskLevel === 'critical' || (riskLevel === 'high' && isUrgent);
                
                return `
                    <div class="threat-item ${riskLevel} ${isUrgent ? 'urgent' : ''} ${isCritical ? 'critical-alert' : ''}">
                        <div class="threat-header">
                            <strong>${classification.primary_threat || 'Unknown Threat'}</strong> 
                            <span class="risk-badge">${riskLevel.toUpperCase()}</span>
                            ${isUrgent ? '<span class="urgent-badge">‚ö° URGENT</span>' : ''}
                        </div>
                        <div class="threat-text">${threat.text}</div>
                        ${locations.length > 0 ? `
                        <div class="threat-locations">
                            üìç ${locations.map(l => `${l.name} (${l.city}, ${l.country})`).join(', ')}
                        </div>
                        ` : ''}
                        <div class="threat-response">
                            üöë ${classification.response_needed || 'Monitoring'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateChart(stats) {
            const ctx = document.getElementById('threatChart').getContext('2d');
            
            if (threatChart) {
                threatChart.destroy();
            }
            
            threatChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(stats.threat_types),
                    datasets: [{
                        data: Object.values(stats.threat_types),
                        backgroundColor: ['#ff0000', '#ff6b00', '#ffd000', '#00ff00', '#007bff']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#00ff00',
                                boxWidth: 12,
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update every 10 seconds
        setInterval(updateDashboard, 10000);
        updateDashboard(); // Initial load
    </script>
</body>
</html>